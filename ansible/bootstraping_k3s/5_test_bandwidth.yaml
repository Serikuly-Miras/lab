---
- name: Check nodes comm speed with iperf3
  hosts: k3s_cluster
  become: yes
  tasks:
    - name: Gather package facts
      ansible.builtin.package_facts:

    - name: Ensure iperf3 is installed
      ansible.builtin.apt:
        name: iperf3
        state: present
        update_cache: yes
      when: "'iperf3' not in ansible_facts.packages"

    - name: Create directory for iperf3 results
      file:
        path: /tmp/iperf3_results
        state: directory
        mode: "0777"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Start iperf3 servers on all nodes
      command: iperf3 -s -D
      changed_when: false

    - name: Get all hosts in inventory
      set_fact:
        all_hosts: "{{ groups['k3s_cluster'] }}"
      run_once: true

    - name: Generate test pairs
      set_fact:
        test_pairs: "{{ test_pairs | default([]) + [{'src': item[0], 'dst': item[1], 'src_ip': hostvars[item[0]].ansible_host, 'dst_ip': hostvars[item[1]].ansible_host}] }}"
      loop: "{{ groups['k3s_cluster'] | product(groups['k3s_cluster']) | list }}"
      when: item[0] != item[1]
      run_once: true

    - name: Run all iperf3 tests sequentially from control node
      delegate_to: localhost
      become: no
      run_once: true
      block:
        - name: Create local results directory
          file:
            path: ./iperf3_results
            state: directory

        - name: Run iperf3 tests one by one
          shell: |
            ssh -o StrictHostKeyChecking=no {{ ansible_user }}@{{ item.src_ip }} "iperf3 -c {{ item.dst_ip }} -t 5 -J > /tmp/iperf3_results/{{ item.src }}_to_{{ item.dst }}.json"
            scp -o StrictHostKeyChecking=no {{ ansible_user }}@{{ item.src_ip }}:/tmp/iperf3_results/{{ item.src }}_to_{{ item.dst }}.json ./iperf3_results/
          loop: "{{ test_pairs }}"
          register: test_results
          ignore_errors: yes

    - name: Parse and display results
      run_once: true
      delegate_to: localhost
      become: no
      shell: |
        echo "===== iperf3 RESULTS SUMMARY ====="
        echo "FROM HOST       | TO HOST         | BANDWIDTH"
        echo "----------------|-----------------|------------"
        for file in ./iperf3_results/*.json; do
          if [ -f "$file" ]; then
            from=$(basename $file | cut -d'_' -f1)
            to=$(basename $file | cut -d'_' -f3 | cut -d'.' -f1)
            bw=$(cat $file | jq -r '.end.sum_received.bits_per_second/1000000 | floor | tostring + " Mbps"')
            printf "%-15s | %-15s | %s\n" "$from" "$to" "$bw"
          fi
        done
      args:
        executable: /bin/bash
      register: parsed_results

    - name: Remove results directory on remote nodes
      file:
        path: /tmp/iperf3_results
        state: absent

    - name: Clean up local results
      delegate_to: localhost
      become: no
      run_once: true
      block:
        - name: Remove previous local results directory
          file:
            path: ./iperf3_results
            state: absent

    - name: Display formatted results
      debug:
        msg: "{{ parsed_results.stdout_lines }}"
      run_once: true

    - name: Kill iperf3 servers
      shell: pkill iperf3 || true
      changed_when: false
