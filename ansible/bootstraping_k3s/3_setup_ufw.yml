- name: Setup UFW rules
  hosts: k3s_cluster
  become: true
  tasks:
    - name: Gather package facts
      ansible.builtin.package_facts:

    - name: Ensure UFW is installed
      ansible.builtin.apt:
        name: ufw
        state: present
        update_cache: yes
      when: "'ufw' not in ansible_facts.packages"

    - name: Reset UFW to default settings
      ansible.builtin.ufw:
        state: reset

    - name: Deny incoming by default
      ansible.builtin.ufw:
        default: deny
        direction: incoming

    - name: Deny routed by default
      ansible.builtin.ufw:
        default: deny
        direction: routed

    - name: Allow outgoing by default
      ansible.builtin.ufw:
        default: allow
        direction: outgoing

    - name: Allow SSH
      community.general.ufw:
        rule: allow
        name: OpenSSH

    - name: Allow pod network
      community.general.ufw:
        rule: allow
        src: 10.42.0.0/16

    - name: Allow service network
      community.general.ufw:
        rule: allow
        src: 10.43.0.0/16

    - name: Allow inter node communication
      community.general.ufw:
        rule: allow
        from_ip: "{{ hostvars[item]['ansible_default_ipv4']['address'] }}"
      loop: "{{ groups['k3s_cluster'] }}"
      when: inventory_hostname != item

    - name: Allow HTTP (80) for Traefik Ingress
      community.general.ufw:
        rule: allow
        port: 80
        proto: tcp
      when:
        - inventory_hostname in groups['server']

    - name: Allow HTTPS (443) for Traefik Ingress
      community.general.ufw:
        rule: allow
        port: 443
        proto: tcp
      when:
        - inventory_hostname in groups['server']

    - name: Enable ufw
      ansible.builtin.ufw:
        state: enabled
