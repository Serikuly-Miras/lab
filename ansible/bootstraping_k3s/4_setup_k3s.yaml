---
- name: Setup k3s master and worker nodes
  hosts: k3s_cluster
  become: yes
  vars_files:
    - vault.yml
  tasks:
    - name: Check if k3s is installed
      ansible.builtin.stat:
        path: /usr/local/bin/k3s
      register: k3s_bin

    - name: Install k3s initial master
      ansible.builtin.shell: |
        curl -sfL https://get.k3s.io | K3S_TOKEN={{ k3s_token }} sh -s - server
      when:
        - inventory_hostname in groups['server']
        - inventory_hostname == groups['server'][0]
        - not k3s_bin.stat.exists

    - name: Install k3s worker
      ansible.builtin.shell: |
        curl -sfL https://get.k3s.io | K3S_URL="https://{{ api_endpoint }}:6443" K3S_TOKEN={{ k3s_token }} sh -s - agent
      when:
        - inventory_hostname in groups['agent']
        - not k3s_bin.stat.exists
